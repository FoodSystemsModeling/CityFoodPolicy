---
eval: false
---

### Description of Data Sources

All of the data from this file will be used to inform the supply chain of the ABM model.

In this file we compile and merge data from three sources:

1.  Businesses that have previously sold to New York City
2.  Businesses that are located in New York from the Simply Analytics database that are processors or wholesalers/distributors of beans, leafy greens, or beef
3.  Businesses that were interviewed as part of this project.
4.  Businesses that were part of a list of businesses that sell NY Grown and Certified products

The following information is needed from each business:

-   Location (in NY or not)
-   Role in the supply chain
-   Has the business sold to New York City
-   Does the business sell multiple commodities
-   MWBE or not
-   Works with local farms
-   Inventory capacity

In all data sets, the capitalization is different. We just leave all data capitalized so as to not have issues with matching that are a result of capitalization.

**Location** All data sets have information on if the business is located in NYS or not

**Role in the supply chain** For those businesses that are wholesalers/distributors, we have that information in all data sets. For processors, we do not have detailed enough information available in the SimplyAnalytics data and those are gathered by hand through web searches. For example with beans, we know which businesses process beans but we do not know if they are a primary or secondary processor. We do have that level of detail available in the data gathered through our interviews.

**Has the business sold to NYC** Any business that is in the NYC data we indicate has sold to NYC, we assume all other businesses have not.

**Does the business sell multiple commodities** These data are not available in the SimplyAnalytics data and are collected manually in a similar manner to the role in the supply chain.

**MWBE** These data are listed in the NYC data and the interview data. For the SimplyAnalytics data, in order to determine if businesses are MWBE, we use a [New York State database](https://ny.newnycontracts.com/FrontEnd/searchcertifieddirectory.asp) and a [NYC database](https://sbsconnect.nyc.gov/certification-directory-search/).

**Works with local farms** Businesses that sell locally are assumed to be those that were interviewed as part of this project and those found in the [Vendor Contact List in the NY Food Product Database](https://airtable.com/appNXQOhJImA3BVPc/shrCt48jrimPvahnI/tbliBTDzNm9JyA4vF/viwddIxh0H1NqtqHG?blocks=bipgl599cpG2pS1XM).

**Inventory capacity** Data from SimplyAnalytics have sales volumes, data from NYC has sales to NYC from the three commodities of interest, and a few of the respondents from the interview data have inventory capacity. {{Becca ADD here how computed}}.

Note: We have removed business names and phone numbers, but have retained addresses and latitude/longitude. In some cases, businesses were matched in these data using names. Those data are not available in this public repository. 

### Simply Analytics

[Simply Analytics](https://johnson.library.cornell.edu/database/simplyanalytics) is a web-based mapping application that allows users to map bushiness by name or by industry. Data are available to Cornell researchers through the Management Library. We collected data from (ADD YEAR) on the NAICS codes that are relevant to processing, distribution and wholesaling of dry beans, beef and leafy greens.

We use data aggregated at the 6-digit NAICS code.

We assume wholesalers/wharehousing and storage is the same for all commodities and that processing is commodity specific.

The NAICS codes of interest for us include:

-   311211 Flour Milling (beans)
-   311411 Frozen Fruit, Juice, and Vegetable Manufacturing (leafy greens)
-   311412 Frozen Specialty Food Manufacturing (beans and leafy greens)
-   311421 Fruit and Vegetable Canning (beans and leafy greens)
-   311422 Specialty Canning (beans, leafy greens, beef)
-   311611 Animal (except Poultry) Slaughtering (beef)
-   311612 Meat Processed from Carcasses (beef)
-   311613 Rendering and Meat Byproduct Processing (beef)
-   311615 Poultry Processing (beans, leafy greens, beef)
-   311812 Commercial Bakeries (leafy greens - knishes)
-   311813 Frozen Cakes, Pies, and Other Pastries Manufacturing (leafy greens - knishes)
-   311824 Dry Pasta, Dough, and Flour Mixes Manufacturing from Purchased Flour (beans)
-   424420 Packaged Frozen Food Merchant Wholesalers
-   424440 Poultry and Poultry Product Merchant Wholesalers
-   424410 General Line Grocery Merchant Wholesalers
-   424420 Packaged Frozen Food Merchant Wholesalers
-   424470 Meat and Meat Product Merchant Wholesalers
-   424480 Fresh Fruit and Vegetable Merchant Wholesalers
-   424490 Other Grocery and Related Products Merchant Wholesalers
-   424510 Grain and Field Bean Merchant Wholesalers
-   484110 General Freight Trucking, Local
-   484121 General Freight Trucking, Long-Distance, Truckload
-   484122 General Freight Trucking, Long-Distance, Less Than Truckload
-   493110 General Warehousing and Storage
-   493120 Refrigerated Warehousing and Storage
-   493130 Farm Product Warehousing and Storage
-   493190 Other Warehousing and Storage

#### Import and clean data

```{r}
library(tidyverse)
library(openxlsx)
library(janitor)
library(readxl)

# Create workbook
wb <- createWorkbook()

# Define file path
file_path <- "data_raw/ToddNAICS4.xlsx"

# Define sheet names of interest
sheet_names <- c("Wholesaling (42)", "Transportation (48)", 
                 "Warehousing & Storage (49)")

# Import data
naics_df <- sheet_names %>% 
  set_names() %>% 
  map_dfr(~read_excel(file_path, sheet = .x) %>% 
            select(NAICS, Description, `Company Name`, `Business Name`, 
                   City, State, `Zip Code`, 
                   `Sales Volume`, `Total Employees`, `Local Employees`, 
                   `Year Started`) %>%
            mutate(
              `Zip Code` = as.character(`Zip Code`), 
              `Year Started` = as.numeric(`Year Started`)), 
          .id = "sheet_name") %>% 
  clean_names()

# Import manufacturing data separately due to different column names 
mfg <- read_excel("data_raw/ToddNAICS4.xlsx", 
                  sheet = "Mfg2") %>% 
  clean_names() %>% 
  mutate(sheet_name = "Mfg2", 
         zip_code = as.character(zip_code))

# bind rows
naics_df <- bind_rows(mfg, naics_df)
rm(mfg)

# Filter naics of interest
naics_list <- c("311211", "311411", "311412", "311421", 
                "311422", "311611", "311612", "311613", 
                "311812", "311813", "311824", "311615",
                "424420", "424440", "424410", "424420", 
                "424470", "424480", "424490", "424510", 
                "484110", "484121", "484122", "493110", 
                "493120", "493130", "493190")

naics_df <- naics_df %>% 
  filter(naics %in% naics_list)


```

#### Duplicates

In these data, many companies are listed multiple times if they have multiple locations. In some cases, the data on sales and employees (variables of interest) are repeated and exactly the same across the multiple listings and in some cases they are different. For those observations with different data across the duplicated rows, we want to add up the sales and employment. For those that are the same across duplicated rows, we keep the first row of data.

Of the duplicates, one business is located outside of NY.

```{r}

# Look at duplicates 
duplicates <- naics_df %>% 
  filter(duplicated(company_name) | duplicated(company_name, fromLast = TRUE))

# Create a dummy variable that indicates if sales and employment data is duplicated or not
naics_df <- naics_df %>% 
  group_by(company_name) %>%
  mutate(
    same = case_when(
      n_distinct(sales_volume)==1 & 
        n_distinct(total_employees)==1 & 
         n_distinct(local_employees)==1 ~ 1, 
      TRUE ~ 0)) 
    
# Summarise data for those that are duplicated and different and return first row for those that are duplicated and the same
naics_df <- naics_df %>% 
  select(naics, description, company_name, state, sales_volume, 
         total_employees, local_employees, same) %>%
  group_by(naics, description, company_name, state) %>%
  reframe(
    sales_volume = case_when(
      same==0 ~ sum(sales_volume), 
      same==1 ~ first(sales_volume)),
    total_employees = case_when(
      same==0 ~ sum(total_employees), 
      same==1 ~ first(total_employees)), 
    local_employees = case_when(
      same==0 ~ sum(local_employees), 
      same==1 ~ first(local_employees))) %>% 
  ungroup() %>%
  distinct(company_name, .keep_all = TRUE)

```

#### Define variables

**Locally owned** Using these data, we add a variable "Locally owned". This is defined as not locally owned (i.e, locally_owned==0) when total employees equals zero or if total employees are greater than local employees. Otherwise, it is a local employer.

**Supply chain role** For the the processing sectors of the supply chain, we specify the commodity, and for the wholesale/distribution sectors we assume the sell all three commodities.

For beans, there are cleaner/aggregators, primary processors, and secondary processors. There are only a couple of cleaner/aggregators in the state and all are known. From the SimplyAnalytics data, we only know if the business is a bean processor, we don't know if it is a primary or secondary processor. We will indicate here that the business is a bean processor (based on the NAICS) and primary/secondary processor will be hand coded based on web searches.

**Located in NY or not** We create a dummy variable with a 1 if in NY and 0 otherwise.

```{r}

# Define locally owned
naics_df <- naics_df %>% 
  mutate(
    locally_owned = case_when(
      total_employees==0 | 
        total_employees>local_employees ~ 0, 
      TRUE ~ 1))

# Supply chain role
naics_df <- naics_df %>% 
  mutate(
    beans_processor = case_when(
      naics %in% c(311211, 311412, 311421, 311422, 311824, 311615) ~ 1, 
      TRUE ~ 0), 
    leafy_greens_processor = case_when(
      naics %in% c(311411, 311412, 311421, 311422, 311812, 311813, 311615) ~ 1, 
      TRUE ~ 0), 
    beef_processor = case_when(
      naics %in% c(311422, 311611, 311612, 311613, 311615) ~ 1, 
      TRUE ~ 0), 
    wholesaler_distributor = case_when(
      naics %in% c(424420, 424440, 424410, 424420, 
                    424470, 424480, 424490, 424510, 
                    484110, 484121, 484122, 493110,  
                    493120, 493130, 493190) ~ 1, 
      TRUE ~ 0))

# Define NY dummy
naics_df <- naics_df %>% 
  mutate(
    ny = case_when(
      state=="NY" ~ 1, 
      TRUE ~ 0))

# drop data that has na for company name
naics_df <- naics_df %>% 
  filter(!is.na(company_name))

# Keep columns of interest
naics_df <- naics_df %>% 
  select(-state)

# Add source
naics_df <- naics_df %>% 
  mutate(
    simply_analytics=1)

```

### New York City Purchasing

Here we want the data from Citywide, which is what is downloaded when you download the full purchasing data from the [NYC Food Policy Dashboard](https://www.nyc.gov/site/foodpolicy/good-food-purchasing/citywidedata.page).

We keep all data relevant to our three commodities for the year 2022, based on primary food product category equal to legumes, vegetables, or beef.

We assume for the column called ny_state_spend_y_n, a y means that the food purchased was from New York State. Here I add a variable called ny = 1 if Yes. This is the same as the state column from the Simply Analytics data. This is different than in the SimplyAnalytics data that indicates where the business is located.

We assume all businesses listed under origin_detail are processors and get the beef, beans, greens based on the products they sold and all other businesses are wholesaler/distributors.

We want to match data for all businesses listed. For each row there is a column called origin detail, distributor and vendor. In some cases the businesses are the same and in others they are not. We assume the information listed in each row pertains to all businesses listed in the row (e.g., if the row says MWBE==1, then the origin detail, distributor and vendor business is MWBE). We create a new column called company_name that includes all of the businesses listed in each column. We do not retain the columns pertaining to how much was purchased by NYC.

```{r}

# Import data
nyc_df <- read_xlsx("data_raw/Public-Dashboard-Data-for-Download-FY19-23.xlsx", 
                 sheet = "Citywide") %>% 
  clean_names()

# filter data of interest
nyc_df <- nyc_df %>% 
  filter(time_period ==2022 & 
           primary_food_product_category %in% c("Beef", "Legumes", "Vegetables")) 

# Keep variables of interest
nyc_df <- nyc_df %>% 
  select(
    origin_detail, distributor, vendor,
    primary_food_product_category,
    mwbe_y_n:last_col())

# Add supply chain role, ny, sold to nyc, change mwbe to a dummy
nyc_df <- nyc_df %>% 
  mutate(ny = case_when(
           ny_state_spend_y_n=="Y" ~ 1, 
           TRUE ~ 0), 
         sold_to_NYC = 1, 
         mwbe = case_when(
           mwbe_y_n=="Y" ~ 1, 
           TRUE ~ 0)) %>% 
  select(!c(mwbe_y_n, mbe_y_n, wbe_y_n))
   
# Make all business names capitalized to join with Simply Analytics data
nyc_df <- nyc_df %>% 
  mutate(across(c(origin_detail, vendor, distributor),
                ~str_to_upper(.)))

# Keep columns of interest
nyc_df <- nyc_df %>% 
  select(origin_detail, vendor, distributor, primary_food_product_category,
         ny:last_col())

# Get one column with all business names from origin_detail, vendor, distributor
nyc_df <- nyc_df %>% 
  pivot_longer(
    cols = !c(primary_food_product_category, ny, sold_to_NYC, mwbe), 
    names_to = "name", 
    values_to = "company_name") 

# Add supply chain location 
nyc_df <- nyc_df %>% 
  mutate(
    beans_processor = case_when(
      name == "origin_detail" & primary_food_product_category=="Legumes" ~ 1, 
      TRUE ~ 0), 
    beef_processor = case_when(
      name == "origin_detail" & primary_food_product_category=="Beef" ~ 1, 
      TRUE ~ 0),
    leafy_greens_processor = case_when(
      name == "origin_detail" & primary_food_product_category=="Vegetables" ~ 1, 
      TRUE ~ 0),
    wholesaler_distributor = case_when(
      name %in% c("vendor", "distributor") ~ 1, 
      TRUE ~ 0))

# Keep distinct observations only and drop blanks
nyc_df <- nyc_df %>% 
  distinct(company_name, .keep_all = TRUE) %>% 
  filter(company_name != "(BLANK)")

# drop data that has na for company name
nyc_df <- nyc_df %>% 
  filter(!is.na(company_name)) 

# Drop columns we don't need
nyc_df <- nyc_df %>% 
  select(company_name, ny, sold_to_NYC, mwbe, 
         beans_processor:last_col())

# Add source
nyc_df <- nyc_df %>% 
  mutate(
    nyc_dashboard = 1)

```

### NYC purchasing collected by June

June collected additional NYC purchasing data from businesses listed in 2023. These get a special designation as they will be included as our out of state businesses that are explicitly included in the model.

```{r}

# Import data
nyc_23_df <- read_xlsx("data_raw/nyc_dashboard_2023additions.xlsx")

# Make business names upper case
nyc_23_df <- nyc_23_df %>% 
  mutate(company_name = toupper(company_name))

# Add in identification 
nyc_23_df <- nyc_23_df %>% 
  mutate(outofstate_business = 1)

```

### Interview data (City Food Policy project)

Lastly, we import data on the businesses that were interviewed as part of the qualitative team interviews for this project. These businesses are designated as local and regional food system businesses indicating they could distribute source identified product (lrfs_business==1).

These data include some businesses that were not interviewed. I only include the rows, Wild Kale through Vermont Bean Crafters (i.e., those with data included in a additional columns).

There are a few files with the same data, we use the file DryBean_SupplyChain_data.xlsx as it has the data that we need in the easiest format to use.

```{r}

# Import data collected by the qualitative team
qual_df <- read_xlsx("data_raw/DryBean_SupplyChain_Data.xlsx", 
                     sheet = "Sheet1") %>% 
  clean_names()


# Keep only data from those that were interviewed
qual_df <- qual_df %>% 
  filter(!is.na(agents_tolerence_for_risk))

# Change columns to be consistent (make business name capitalized to match with other data)
qual_df <- qual_df %>% 
  mutate(
    company_name = str_to_upper(business_name), 
    ny = case_when(
      in_state_out_of_state == "In-state" ~ 1, 
      TRUE ~ 0), 
    aggregator_cleaner = case_when(
      str_detect(supply_chain_segment, "Aggregator|Cleaner|cleaner") ~ 1, 
      TRUE ~ 0), 
    primary_processor = case_when(
      str_detect(supply_chain_segment, "Primary Processor") ~ 1, 
      TRUE ~ 0), 
    secondary_processor = case_when(
      str_detect(supply_chain_segment, "Secondary Processor") ~ 1, 
      TRUE ~ 0), 
    wholesaler_distributor = case_when(
      str_detect(supply_chain_segment, "Wholesaler|Distributor|copacker") ~ 1, 
      TRUE ~ 0))

# Keep data of interest
qual_df <- qual_df %>% 
  select(company_name, ny, aggregator_cleaner:wholesaler_distributor, 
         mwbe, potential_maximum_inventory_capacity_annual_growth:product_attributes_organic)


# Add local and regional food system business indicator for all businesses
qual_df <- qual_df %>% 
  mutate(
    lrfs_business=1)

# Add a new column (to match with other data) on businesses that are beans processor
qual_df <- qual_df %>% 
  mutate(
    beans_processor = case_when(
      aggregator_cleaner==1 | 
        primary_processor==1 | 
        secondary_processor==1 ~ 1, 
      TRUE ~ 0)) 

# Add source
qual_df <- qual_df %>% 
  mutate(
    interview_data = 1)

```

### NY Food Product Database

We use data the [NY Food Product Database](https://airtable.com/appNXQOhJImA3BVPc/shrCt48jrimPvahnI/tbliBTDzNm9JyA4vF/viwddIxh0H1NqtqHG?blocks=bipgl599cpG2pS1XM) to identify businesses that sell New York branded products (lrfs==1).

We also keep any business listed here and not in the other data baseses.

I assume the the MWBE certification is for the wholesaler and not for the processor.

```{r}

# Import data
ny_foods_df <- read_csv("data_raw/NY Food Products - Approved-Grid View.csv") %>% 
  clean_names()

# Select data of interest
ny_foods_df <- ny_foods_df %>% 
  select(sub_category, manufacturer, distributors, certifications)

# Keep only those that have ny grown certification
ny_foods_df <- ny_foods_df %>% 
  filter(str_detect(certifications, "NY Grown & Certified"))

# Add processor type based on sub_category
ny_foods_df <- ny_foods_df %>% 
  mutate(
    beans_processor = case_when(
      str_detect(sub_category, "Legumes") ~ 1, 
      TRUE ~ 0), 
    beef_processor = case_when(
      str_detect(sub_category, "Meat") ~ 1, 
      TRUE ~ 0), 
    leafy_greens_processor = case_when(
      str_detect(sub_category, "Vegetables") ~ 1, 
      TRUE ~ 0)) %>% 
  select(!sub_category)

## Add MWBE certification
ny_foods_df <- ny_foods_df %>% 
  mutate(
    mwbe = case_when(
      str_detect(certifications, "M/WBE") ~ 1, 
      TRUE ~ 0))

# Multiple distributors are listed in each row separated by a comma, make into a separate list
ny_foods_df <- ny_foods_df %>%
  separate_rows(distributors, sep = ",\\s*(?!\\s*Inc)") %>%
  mutate(distributors = str_trim(distributors), 
         distributors = str_remove_all(distributors, '["\']'))

# Drop certification and merge columns with manufacturer and distributor in one list
man <- ny_foods_df %>% 
  select(manufacturer, beans_processor, beef_processor, 
         leafy_greens_processor) %>% 
  rename(company_name = manufacturer)

dis <- ny_foods_df %>% 
  select(distributors, mwbe) %>% 
  rename(company_name = distributors) %>% 
  mutate(wholesaler_distributor = 1)

ny_foods_df <- bind_rows(man, dis)

# Fill NA's with zero
ny_foods_df <- ny_foods_df %>% 
  mutate(across(beans_processor:last_col(), 
                ~replace_na(., 0)))

# Drop duplicates
ny_foods_df <- ny_foods_df %>% 
  distinct()

# In some cases, there are multiple rows for the same business due to due them being a processor and distributor, we combine this information into one row
ny_foods_df <- ny_foods_df %>% 
  group_by(company_name) %>% 
  summarise(across(beans_processor:last_col(), 
                   ~max(.))) %>% 
  ungroup()

# Make upper case and add lrfs column
ny_foods_df <- ny_foods_df %>% 
  mutate(company_name = toupper(company_name), 
         lrfs_business = 1)

```

### Combine data

Here we merge our data. Because we have only a small handful of businesses that are in multiple data sets and those might have slightly different names, we first match those businesses in multiple data sets and then bind the remaining data after.

I first create a list of all business names listed in the NYC data in each of the columns, origin detail, vendor, distributor. Then I join this with the Simply Analytics data.

I then join the SimplyAnalytics data with the interview data.

```{r}

# Join NYC and SimplyAnalytics data using a fuzzy join, we want to keep all data and remove duplicates, there are no matches with the interview data
df_sa_nyc <- fuzzyjoin::stringdist_inner_join(nyc_df, naics_df, 
                            by = "company_name", 
                            max_dist = 0.15, 
                            method = "jw")

# Visually inspect and drop those not the same
df_sa_nyc <- df_sa_nyc %>% 
  filter(!company_name.y %in% c("HEALTHY PET FOODS INC.",	
                                "CHROMEO"))

# Keep only one company name
df_sa_nyc <- df_sa_nyc %>% 
  select(-company_name.y) %>% 
  rename(company_name = company_name.x)

# Keep only the supply chain location from the NYC data and not Simply Analytics
df_sa_nyc <- df_sa_nyc %>% 
  select(-ends_with(".y")) 

# remove .x at the end of some variables
df_sa_nyc <- df_sa_nyc %>% 
  rename_with(~str_remove(.x, "\\.x$"), ends_with(".x"))

## Join data from SA and interview data, keeping all columns from both data sets
df_sa_qual <- fuzzyjoin::stringdist_inner_join(qual_df, naics_df, 
                                       by = "company_name", 
                                       max_dist = 0.15, 
                                       method = "jw")

# Drop those that matched wrong
df_sa_qual <- df_sa_qual %>% 
  filter(!company_name.y %in% c("NEW YORK ONE LLC", "NEW YORK EMPANADA LLC"))

# Keep only one company name
df_sa_qual <- df_sa_qual %>% 
  rename(company_name = company_name.x) 

# Keep only the supply chain location from the interview data and not Simply Analytics
df_sa_qual <- df_sa_qual %>% 
  select(-ends_with(".y")) 

# remove .x at the end of some variables
df_sa_qual <- df_sa_qual %>% 
  rename_with(~str_remove(.x, "\\.x$"), ends_with(".x"))

# Join all merged data
df <- bind_rows(df_sa_nyc, df_sa_qual)

# Add in zeros rather than NA for some columns
df <- df %>% 
  mutate(across(c(lrfs_business, nyc_dashboard, interview_data), 
                ~case_when(
                  is.na(.) ~ 0, 
                  TRUE ~ .)))

# Join NY certified data
lrfs <- fuzzyjoin::stringdist_inner_join(df, ny_foods_df, 
                            by = "company_name", 
                            max_dist = 0.15, 
                            method = "jw")

# Pull list of lrfs businesses that match
lrfs <- lrfs %>% 
  select(company_name.x) %>% 
  pull()

# Add lrfs_business==1 to those businesses that match
df <- df %>% 
  mutate(
    lrfs_business = case_when(
      company_name %in% lrfs ~ 1, 
      TRUE ~ lrfs_business))
  
```

#### Drop merged data from original data

Because we are binding all data, we want to drop anything that did match from the original data sources.

```{r}

# Get a list of data that has matched and remove it from the other data sets
company_list <- df %>% 
  select(company_name) %>% 
  pull()

# Drop from naics
naics_df <- naics_df %>% 
  filter(!company_name %in% company_list)

# Drop from nyc
nyc_df <- nyc_df %>% 
  filter(!company_name %in% company_list)

# Drop from interview
qual_df <- qual_df %>% 
  filter(!company_name %in% company_list)

# Drop from nyc grown
ny_foods_df <- ny_foods_df %>% 
  filter(!company_name %in% company_list)
```

#### Combine all data

```{r}

# Bind all data
df <- bind_rows(df, naics_df, nyc_df, qual_df, nyc_23_df, ny_foods_df)

# Convert NA's to zero where appropriate
df <- df %>% 
  mutate(across(c(ny:nyc_dashboard, simply_analytics, interview_data, 
                  lrfs_business, outofstate_business), 
                ~case_when(
                  is.na(.) ~ 0, 
                  TRUE ~ .)))

# Put in correct order
df <- df %>% 
  select(
    company_name, ny, 
    beans_processor, beef_processor, leafy_greens_processor, wholesaler_distributor, 
    primary_processor, secondary_processor, aggregator_cleaner,
    sold_to_NYC, mwbe, lrfs_business, outofstate_business, 
    nyc_dashboard, simply_analytics, interview_data, everything())
    
```

#### Add MWBE

New York State provides a database with all [New York State Contractors that are certified MWBE](https://ny.newnycontracts.com/FrontEnd/searchcertifieddirectory.asp) and by [New York City](https://sbsconnect.nyc.gov/certification-directory-search/).

We select the following [commodity codes](https://www.nyc.gov/assets/sbs/downloads/pdf/businesses/certification/new-york-city-commodity-code-listing.pdf):

-   019 - AGRICULTURAL CROPS AND GRAINS INCLUDING FRUITS, MELONS, NUTS
-   375 - FOODS: BAKERY PRODUCTS (FRESH)
-   380 - FOODS: DAIRY PRODUCTS (FRESH)
-   385 - FOODS, FROZEN
-   390 - FOODS: PERISHABLE
-   393 - FOODS: STAPLE GROCERY AND GROCER'S MISCELLANEOUS ITEMS

```{r}

# Import MWBE directories, keep data of interest and make capital
mwbe_ny <- read_csv("data_raw/Directory_2025-05-30_862.csv", 
                    skip = 5) %>% 
  clean_names() %>%
  select(company_name) %>% 
  mutate(company_name = str_to_upper(company_name))

mwbe_nyc <- read_xlsx("data_raw/OnlineDirectory06042025.xlsx", 
                      skip = 6) %>% 
  clean_names() %>% 
  mutate(company_name = str_to_upper(vendor_formal_name)) %>% 
  select(company_name)

# Join data (convert to UTF-8 format in order to join)
mwbe <- full_join(mwbe_ny, mwbe_nyc) %>% 
  mutate(mwbe = 1, 
         company_name = iconv(company_name, from = "", to = "UTF-8"))

rm(mwbe_ny, mwbe_nyc)

# Join with other data so see if overlap
fuzzy_match <- fuzzyjoin::stringdist_inner_join(df, mwbe, 
                                       by = "company_name",
                                       max_dist = 0.05, 
                                       method = "jw")
fuzzy_match <- fuzzy_match %>% 
  select(company_name.x, company_name.y)

# Drop those matches that are wrong and keep only data of interest
fuzzy_match <- fuzzy_match %>% 
  filter(
    !company_name.x %in% c(
      "MARATHON ENTERPRISES, INC.",
      "2002 TRUCKING INC.",
      "AMO TRUCKING LLC", 
      "EJL TRUCKING LLC", 
      "FMM TRUCKING LLC", 
      "JLA TRUCKING LLC", 
      "JML TRUCKING LLC", 
      "JMM TRANSPORTATION CORP", 
      "JNL TRUCKING LLC", 
      "JSA TRUCKING LLC", 
      "JSD TRUCKING LLC", 
      "JSF TRUCKING LLC", 
      "SBM TRUCKING LLC", 
      "SFM TRUCKING LLC", 
      "SM TRUCKING, LLC", 
      "SMS TRUCKING LLC", 
      "WDS TRUCKING LLC", 
      "JOEY TRANSPORTATION LLC", 
      "LAHR CONSTRUCTION CORP.")) %>% 
  rename(company_name = company_name.x) %>% 
  distinct(company_name)
      
# Create a list of mwbe businesses and use that to add mwbe to df
mwbe_list <- fuzzy_match %>% 
  pull(company_name)

df <- df %>% 
  mutate(
    mwbe = case_when(
      company_name %in% mwbe_list ~ 1, 
      TRUE ~ mwbe))

```

#### Save

The list of businesses we have here is a complete list of all businesses in the supply chain, but key information is missing and must be found manually.

We assume that any business that sells through the local supply chain (i.e., was interviewed by June, sold to NYC previously, or was part of the list of businesses that are NY Grown & Certified) should be part of the main part of our model. For this set of businesses, we gather additional information manually. All other businesses are in the model, but not explicitly modeled.

```{r}

# Create separate spreadsheets for beans data inside the model and outside the model
df_beans <- df %>% 
  filter(wholesaler_distributor==1 | beans_processor==1)
    
df_beans_inside_model <- df_beans %>% 
  filter(lrfs_business==1 | outofstate_business==1 | sold_to_NYC==1)

inside_list <- df_beans_inside_model %>% 
  pull(company_name)

df_beans_outside_model <- df_beans %>% 
  filter(!company_name %in% inside_list)

# Create a new df for leafy greens and beef processors
df_leafygreens <- df %>% 
  filter(leafy_greens_processor==1 & beans_processor==0)

df_beef <- df %>% 
  filter(beef_processor==1 & beans_processor==0)

## Add worksheets
addWorksheet(wb, "beans_inside_model")
writeData(wb, "beans_inside_model", df_beans_inside_model)
addWorksheet(wb, "beans_outside_model")
writeData(wb, "beans_outside_model", df_beans_outside_model)

addWorksheet(wb, "leafy_greens_processor")
writeData(wb, "leafy_greens_processor", df_leafygreens)
addWorksheet(wb, "beef_processor")
writeData(wb, "beef_processor", df_beef)

addWorksheet(wb, "all_data")
writeData(wb, "all_data", df)

# Add info
info <- tibble(
  sheet_name = c("beans_inside_model", "beans_outside_model", 
                 "leafy_greens_processor", "beef_processor"), 
  description = c(
    "processor, wholesale and distributions businesses that could process/sell beans or do sell beans and are assumed to be inside the model. Data is manually added to this list of businesses",
    "processor, wholesale and distributions businesses that could process/sell beans or do sell beans and are assumed to be outside the model",
    "processor businesses that could or do process leafy greens",
    "processor businesses that could or do process beef"),
  data_source = "Simply Analytics, New York City purchasing data, interview data, NY Grown and Certified",
  notes = "We combined data from all sources to make one list of the supply chain businesses")

# Add metadata
meta <- tibble(
  variable_name = c(
    "company_name", "ny", "beans/beef/lettuce processor",
    "wholesaler_distributor", "primary_processor", 
    "secondary_processor", "aggregator_cleaner",
    "sold_to_nyc", "mwbe", "lrfs_business", "outofstate_business",
    "nyc_dashboard", "simply_analytics", "interview_data", 
    "all_other"), 
  variable_description = c(
    "Company name", "Location (1 in NY, 0 not in NY)", 
    "Beans/beef/lettuce processor (based on NAICS code in the Simply Analytics data and the origin detail from the NYC data)",
    "Wholesaler/distributor", 
    "Primary processor of beans (only available in the interview data)", 
    "Secondary processor of beans (only available in the interview data)",
    "Aggregator/cleaner (only available in the interview data)", 
    "Business has sold to New York City (we assume all businesses listed in the NYC data sold to NYC and all others did not)",
    "MWBE business (1 is yes and 0 is no) based on interviews, NYC data and matched with the city and state MWBE", 
    "Works with local farms (1 is yes, 0 is no) (all businesses that were interviewed or included in the NY Certified and Grown have a 1 and all others 0)",
    "Businesses that are part of the bean supply chain and located outside of NYC, data gathered by June from the NYC purchasing data in 2023",
    "Data collected from the NYC dashboard (1 is yes 0 is no)", 
    "Data collected from Simply Analytics (1 is yes 0 is no)", 
    "Data collected from interviews (1 is yes 0 is no)",
    "All other variables that were included in each of the data sets, can be used to determine inventory capacity and/or multiple commodities as we do not have that information"))
    
# Add worksheets
addWorksheet(wb, "info")
writeData(wb, "info", info)

addWorksheet(wb, "metadata")
writeData(wb, "metadata", meta)

# Save
saveWorkbook(wb, "data_final/supply_chain_list.xlsx", overwrite = TRUE)
```


### Manual data additions

In this file we take the data that was first complied in "processor_data.qmd", exported and then manually added to in the document "CFP_Supply_Chain_Data_070425.xlsx." We use the sheet "beans_inside_model" which indicates the wholesalers and distributors in the bean supply chain that we assume are "inside the model" and all actors in our agent based model. These entities have previously sold to NYC, have sales through local and regional food systems, or were indicated by the qualitative team to be outside of New York but a player in the system.

In the manual data piece, there were general notes made. Observations were dropped if they did not have any bean products or if they were deemed an incorrect entry.

There are a few errors in the data regarding operations that are located in NY or not, those are fixed. We are also missing address information which we need for some of the model calculations. These are added manually.


```{r}
library(tidyverse)
library(janitor)

df <- readxl::read_xlsx("data_processed/CFP_Supply_Chain_Data_070425.xlsx", 
                        sheet = "beans_inside_model", 
                        skip = 1) %>% 
  clean_names()

# make beans_processor numeric (one entry had a ?)
df <- df %>% 
  mutate(
    beans_processor = as.numeric(beans_processor)
      )

# Keep columns of interest
df <- df %>% 
  select(location, company_name, ny, beans_processor,
         wholesaler_distributor, primary_processor:interview_data,
         sales_volume, total_employees, local_employees,
         locally_owned
         )

```

#### Drop data

The Bush's Best data do not appear to be correct. There are no beans processed near New York.

There are a few businesses that process food for US foods or Sysco under different labels. I was not able to find any address information for these businesses so they are dropped.

METRO COMMODITIES is permanently closed so dropped.

If I wasn't able to find an address, then the business was dropped.

There were multiple entries for Furmano's so we only kept one.

```{r}
# Drop rows with no data
df <- df %>% 
  filter(!is.na(company_name) & 
           company_name != "Unknown")

# Drop data defined as bad data or no beans or no information
df <- df %>% 
  filter(!company_name %in% c(
    "BGAN, CANADA",
    "DEL PASADO",
    "BROWN'S BEST",
    "CARDINAL FOODS",
    "CARLSTAD, NJ", 
    "FOODCO", 
    "FRESH AND TASTY BAKED PRODUCTS", 
    "HANOVER, HANOVER, PA",
    "HANOVER, HOUSTON, TX", 
    "RANCHER'S BEST WHOLESALE MEATS INC.", 
    "SECAUCUS, NEW JERSEY", 
    "SECAUCUS, NJ",
    "SUNFIELD, CHINA", 
    "TONY'S FISH & SEAFOOD CORP.", 
    "WESTSIDE FOODS", 
    "ZAITOON CORP", 
    "DEPEW DAIRY", 
    "G AND C FOOD SERVICE",
    "GENECCO PRODUCE, INC.", 
    "GIANFORTE FARMS", 
    "GILETTE CREAMERY", 
    "HILLCREST FOODS", 
    "HUDSON DAIRY",
    "HUFF", 
    "LATREMORE PINE RIDGE FARM", 
    "LUCKI7 LIVESTOCK COMPANY",
    "MARINA ICE CREAM CORP", 
    "MCMAHONS FARM", 
    "MERCERS DAIRY", 
    "MORNING STAR POULTRY", 
    "RIVIERA PRODUCE", 
    "RUSSO PRODUCE CO.", 
    "SELF DISTRIBUTE - SFOGLINI", 
    "SLATE FOODS", 
    "SMITH PACKING COMPANY INC.", 
    "STEWARTS SHOPS CORP.", 
    "SYSCO", 
    "UPSTATE FARMS", 
    "UPSTATE NIAGARA COOPERATIVE INC.", 
    "WARDYNSKI & SONS INC.", 
    "AMERICAN FRUIT AND VEGETABLE CO.", 
    "BARTLETT DAIRY",
    "BEHLOG & SONS PRODUCE",
    "BEST CHOICE", 
    "BIPPERTS", 
    "BRIGIOTTAS FARMLAND PRODUCE", 
    "BURLY BROTHERS COUNTRY BUTCHERY",
    "BUSH BROTHERS & CO / BUSHS BEST, CHAMBERSBURG, PA",
    "BUSHS BEST, BEAR, DE", 
    "CASACLS", 
    "CATSKILLS AGRARIAN ALLIANCE (607CSA)", 
    "COMFORT FOOD", 
    "CULINARY SELECT, BETHLEHEM, PA",
    "DEL PASADO, MEMPHIS, TN", 
    "DEL PASADO, NORTHUMBERLAND, PA", 
    "FURMANO FOODS INC / FURMANOS, NORTHUMBERLAND, PA", 
    "FURMANO'S, NORTHUMBERLAND, PA",
    "FURMANO",
    "FURMANOS",
    "GOLDEN BAY FOODS LLC / MONARCH, JERSEY CITY, NJ", 
    "GOLDEN PLATTER", 
    "HAN/FURM", 
    "HOUSE FOODS", 
    "METRO COMMODITIES", 
    "MONARCH, WESTFIELD, MA", 
    "MULTIPLE SOURCES / RYKOFF SEXTON, SOUTH BRUNSWICK, NJ",
    "NASOYA FOODS USA LLC / NASOYA, ALLENTOWN, PA", 
    "NATURESOY", 
    "SYS CLS"
    )
  )


```

#### Add address

Here we manually add addresses and fix issues with the ny variable.

For companies with multiple locations, I just chose one.

```{r}

## Add address
df <- df %>% 
  mutate(
    address = case_when(
      company_name == "ACE ENDICO" ~ "80 International Boulevard Brewster, NY 10509", 
      company_name=="BELLA VISTA" ~ "770 Cannery Road, Northumberland, PA 17857", 
      company_name=="CARDINAL FOODS" ~ "130 Grand Street, Carlstadt, NJ 07072", 
      company_name=="CHEF'S CHOICE CASH & CARRY FOOD DISTRIBUTOR INC" ~ "051 Utica Ave, Brooklyn, NY 11203",
      company_name=="CHEF'S ORCHID RESTAURANT" ~ "248-05 Union Turnpike
Bellerose, NY 11426", 
      company_name=="DRISCOLL FOODS FOOD SERVICE / METROPOLITAN FOODS INC." ~ "6 Westbelt, Wayne, NJ 07470", 
      company_name=="FOODCO" ~ "1014 Vine Street Cincinnati, OH 45202", 
      company_name=="NASOYA ORGANIC, USA" ~ "1 New England Way Ayer, MA 01432", 
      company_name=="NEW YORK BEAN, LLC" ~ "2905 Caledonia‚ÄêLeroy Rd, Caledonia, NY 14423", 
      company_name=="R&L GOODS DIST INC." ~ "1123 49th Street, Brooklyn, NY 11219", 
      company_name=="RESTAURANT DEPOT" ~ "566 Hamilton Ave, Brooklyn, NY 11232", 
      company_name=="TERI NICHOLS" ~ "10101 C Avenue D, Brooklyn, NY 11236",
      company_name=="THE CHEF'S KINGDOM" ~ "1 Alpine Ct, Spring Valley, NY 10977", 
      company_name== "US FOODS" ~ "9399 W Higgins Rd Ste 100, Rosemont, IL 60018", 
      company_name=="DICARLO FOODS" ~ "1630 N Ocean Ave, Holtsville, NY 11742", 
      company_name == "DRISCOLL FOODS - METRO NY" ~ "6 Westbelt
Wayne, NJ 07470", 
      company_name =="DRISCOLL FOODS - UPSTATE NY (AMSTERDAM)" ~ "105 Quist Rd, Amsterdam, NY 12010", 
      company_name=="DUSO FOOD DISTRIBUTORS INC." ~ "6055 Route 52, Ellenville, NY 12428", 
      company_name == "FERARRO FOODS" ~ "80 Wilshire Blvd Edgewood NY 11717", 
      company_name== "GINSBERGS FOODS" ~ "29 Ginsbergs Rd, Hudson, NY 12534", 
      company_name=="HEADWATER FOOD HUB" ~ "6318 Ontario Center Rd, Ontario, NY 14519",
      company_name=="HUB ON THE HILL" ~"6700 Main St, Westport, NY 12993", 
      company_name=="HUDSON HARVEST" ~ "1931 US-9, Germantown, NY 12526", 
      company_name=="J. KINGS FOODSERVICE PROFESSIONALS" ~ "700 Furrows Rd, Holtsville, New York 11742", 
      company_name=="JACOBSTEIN FOOD SERVICE" ~ "15 Airline Dr. Rochester, NY 14624", 
      company_name=="LATINA BOULEVARD" ~ "1 Scrivner Dr Suite #1, Buffalo, NY 14227", 
      company_name=="MAPLEVALE" ~ "2063 Allen St Ext, Falconer, NY 14733", 
      company_name=="MIVILA FOODS" ~ "347 Burman Blvd, Calverton, NY 11933", 
      company_name=="PERFORMANCE FOOD SERVICE METRO" ~ "1 Ikea Drive
Elizabeth, NJ 07207", 
      company_name=="RED BARN PRODUCE" ~ "217 Upper North Road, Highland NY 12528", 
      company_name=="REGIONAL ACCESS" ~ "1609 Trumansburg Rd, Ithaca, NY 14850", 
      company_name=="RENZI FOODSERVICE" ~ "901 Rail Drive Watertown, NY 13601", 
      company_name=="SCHRIER FOODSERVICE" ~ "4901 Gleenwood Road, Brooklyn, NY 11234",
      company_name=="SYSCO ALBANY" ~ "1 Liebich Lane Halfmoon, NY 12065", 
      company_name=="SYSCO LONG ISLAND" ~"199 Lowell Avenue Central Islip, NY 11722", 
      company_name=="SYSCO METRO NY" ~ "20 Theodore Conrad Drive Jersey City, NJ 07305", 
      company_name=="SYSCO SYRACUSE" ~ "2508 Warners Road Warners, NY 13164", 
      company_name=="THE HUDSON MILK COMPANY" ~ "1000 N Division St, Peekskill, NY 10566", 
      company_name=="THURSTON FOODS" ~ "30 Thurston Dr, Wallingford, CT 06492", 
      company_name=="US FOODS ALBANY" ~"755 Pierce Rd, Clifton Park, NY 12065", 
      company_name=="US FOODS BUFFALO" ~ "125 Gardenville Parkway West
Buffalo, NY 14224", 
      company_name=="AIR STREAM FOODS" ~ "3400 Lawson Blvd, Oceanside, NY 11572", 
      company_name=="AMERICAN ROLAND FOOD CO / ROLAND, DAYTON, NJ" ~ "1 Industrial Rd Suite 199, Dayton, NJ 08810", 
      company_name=="ANTONNUCI FOODS" ~"274 S Main St, Gloversville, NY 12078", 
      company_name=="BALDOR FOODS"  ~"155 Food Center Dr, The Bronx, NY 10474", 
      company_name=="BIG APPLE DELI PRODUCTS" ~ "150 Fedex Way, Rochester, NY 14624", 
      company_name=="CHEF'S LINE" ~ "2255 High Hill Rd. Bridgeport, NJ 08014", 
      company_name=="CHEFS WAREHOUSE" ~ "240 Food Center Dr, Bronx, NY 10474", 
      company_name=="CURTZE FOOD" ~ "1717 E 12th St, Erie, PA 16511",
      company_name=="DAGELE BROTHERS PRODUCE" ~ "40 Stream Dr, Florida, NY 10921", 
      company_name=="DR PRAEGER" ~ "9 Boumar Place, Elmwood Park, NJ 07407", 
      company_name=="FILLO FACTORY INC."  ~"10 Fairway Ct, Northvale, NJ 07647", 
      company_name=="FURMANO FOODS" ~"770 Cannery Rd, Northumberland, PA 17857", 
      company_name=="GENESEE VALLEY BEAN CO" ~ "4194 Cameron Rd, Caledonia, NY 14423", 
      company_name=="HANOVER FOODS" ~ "1125 Wilson Avenue, Hanover, PA 17331", 
      company_name=="HUDSON  HARVEST" ~"1931 US-9, Germantown, NY 12526", 
      company_name=="MATRIARK FOODS" ~ "246 5th Ave, New York, NY 10001", 
      company_name=="QAULI-PACK USA" ~ "1 Market St # 7, Passaic, NJ 07055", 
      company_name=="RIVERHEAD BEAN COMPANY" ~ "485-17 South Broadway Hicksville, NY 11801",
      company_name=="ROLAND FOODS" ~ "115 W 18th St Floor 5, New York, NY 10011", 
      company_name=="SENECA GRAIN AND BEAN" ~ "1333 Nutt Rd, Penn Yan, NY 14527", 
      company_name=="TRINIDAD BENHAM CORP / JACK RABBIT, LA VERGNE, TN" ~ "140 International Blvd, La Vergne, TN 37086", 
      company_name=="UNI-PAC" ~"111 Coolidge St, South Plainfield, NJ 07080", 
      company_name=="VERMONT BEAN CRAFTERS" ~ "284 Vermont Rte 100, Warren, VT 05674", 
      company_name=="WILD KALE" ~ "211 N End Ave New York, NY 10282", 
      TRUE ~ location) 
  )


# Make sure ny variable is correct
df <- df %>% 
  mutate(
    ny = case_when(
      str_detect(address, "NY|New York") ~ 1, 
      TRUE ~ 0)
    )

# Keep full address and drop location
df <- df %>% 
  select(address, everything()) %>% 
  select(-location)

```

##### Geocode

```{r}

library(tidygeocoder)

# Geocode
df <- df %>%
  geocode(address, 
          method = 'census', 
          lat = latitude, 
          long = longitude,
          full_results = FALSE)

# Manually fix those missing
missing <- df %>% 
  filter(is.na(latitude))


# Fix missing
df <- df %>% 
  mutate(
    latitude = case_when(
      company_name=="GOYA" ~ 40.763031, 
      company_name=="NEW YORK BEAN, LLC" ~ 42.976151, 
      company_name=="R & L FOOD, CANADA" ~ 45.412021, 
      company_name=="WHITSONS CULINARY GROUP" ~ 40.852589, 
      company_name=="GINSBERGS FOODS" ~ 42.2662037,
      company_name=="THURSTON FOODS" ~ 41.4783847,
      company_name=="AMERICAN ROLAND FOOD CO / ROLAND, DAYTON, NJ" ~ 40.3747341, 
      company_name=="CHEF'S LINE" ~ 39.7808195, 
      TRUE ~ latitude), 
    longitude = case_when(
      company_name=="GOYA" ~ -74.068359, 
      company_name=="NEW YORK BEAN, LLC" ~ -77.870369, 
      company_name=="R & L FOOD, CANADA" ~ -75.652283, 
      company_name=="WHITSONS CULINARY GROUP" ~ -73.390443, 
      company_name=="GINSBERGS FOODS" ~ -73.731335,
      company_name=="THURSTON FOODS" ~ -72.7998233,
      company_name=="AMERICAN ROLAND FOOD CO / ROLAND, DAYTON, NJ" ~ -74.4907604, 
      company_name=="CHEF'S LINE" ~ -75.3660808, 
      TRUE ~ longitude)
    )

# Re-order
df <- df %>% 
  select(latitude, longitude, everything())

```

##### Save

```{r}

write_csv(df, "data_final/beans_processor_distributor.csv")

```
