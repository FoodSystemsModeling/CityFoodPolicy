---
title: "Supply Chain Margins"
format: html
editor: visual
---

We use data from interviews to understand margins along the dry bean supply chain, both inside and outside of New York, lead by Michael Hurwitz. Maybe link to other chapters where we discuss interviews. 

After conducting all of the interviews [Michael went through them to pull out all information related to margins](https://github.com/FoodSystemsModeling/CityFoodPolicy/tree/main/drybeans/data_processed/2025_BeanMarginInfo_fromInterviews), reached out to dry bean advisory committee to get clarification where needed.

Additional data collected includes:

-   Cleaner/aggreagtor in New York

    -  \$.06/lb. to \$.08/lb. for all types of beans (differentiated and not) 

-   Cleaner/aggregator margin outside of New York

    -   In North Dakota where there are several cleaners, \$.06/lb.
    -   In Washington St and others with few cleaners, \$.15/lb.
    -   Organic: \$.10/lb. to \$.12/lb.

-   Processor

    -   \$.06 for large scale conventional 

## Pathways

We model conventional and organic dry beans moving through the supply chain.

```{r}

library(tidyverse)
library(openxlsx)

# Define base data frame
margins <- crossing(
  market_channel = c(
    "differentiated", 
    "NYC public institutions", 
    "commodity"),
  type = c(
    "conventional", 
    "organic"), 
  location = c(
    "NY", 
    "outside NY"), 
  scale = c(
    "medium", 
    "large")
  )

# Remove outside NY for differentiated category as this can only by NY beans
margins <- margins %>% 
  filter(
    !(market_channel=="differentiated" & 
        location == "outside NY"))

```

In some cases, the margins for dry beans moving through the differentiated market channel, to public institutions, and to commodity markets are different and these differences are included in the data. In all cases we provide a range.

## Cleaner/aggregator

Data from New York cleaner/aggregators comes from the interviews. 

For the cleaner/aggregator processing New York beans, organic beans have an 11% margin and conventional ranges from 4-9%. Margins do not differ by market channel.

For beans grown outside of New York, the cleaner aggregator mark up cost ranges from \$.06/lb. to \$.15/lb. For organic, these margins are \$.10/lb. to \$.12/lb.

To convert these margins:

-   margin = (selling price - cost)/selling price.
-   selling price - cost = 0.06 to 0.15
-   selling price = commodity price paid to farmer (0.40) + 0.06 = 0.46
-   selling price = commodity price paid to farmer (0.40) + 0.15 = 0.55
-   low margin = 0.06/0.46 = 13%
-   high margin = 

```{r}

# Add cleaner agg
cleaner_agg <- margins %>% 
  mutate(
    supply_chain_node = "cleaner_aggregator")

# Add in margins for NY cleaner/agg
cleaner_agg <- cleaner_agg %>% 
  mutate(
    margin_low = case_when(
      type == "organic" & 
        location == "NY" ~ 0.11, 
      type=="conventional" & 
        location == "NY" ~ 0.04), 
    margin_high = case_when(
      type == "organic" & 
        location == "NY" ~ 0.11, 
      type=="conventional" & 
        location == "NY" ~ 0.09)
    )

## Add in margins for outside of NY cleaner/agg
cleaner_agg <- cleaner_agg %>% 
  mutate(
    margin_low = case_when(
      type == "organic" & 
        location == "outside NY" ~ NA, 
      type=="conventional" & 
        location == "outside NY" ~ 0.06, 
      TRUE ~ margin_low), 
    margin_high = case_when(
      type == "organic" & 
        location == "outside NY" ~ NA, 
      type=="conventional" & 
        location == "outside NY" ~ 0.15, 
      TRUE ~ margin_high)
    )

```

## Primary processor

Conventional & organic canning margin ranges from 6-10%. Conventional & organic dry beans bagging margin ranges from 15-20%

### Canning

There are no differences for by conventional/organic or by scale.

```{r}

# Canning
primary_processor_canning <- margins %>%
  mutate(
    supply_chain_node = "primary_processor_canning", 
    margin_low = 0.06, 
    margin_high = 0.10)
  
```

### Bagging

ADD where this is from

```{r}

primary_processor_bagging <- margins %>%
  mutate(
    supply_chain_node = "primary_processor_bagging", 
    margin_low = 0.15, 
    margin_high = 0.20)

```

## Secondary processor

These include products that are frozen or otherwise processed, but do not include canned beans. Canned beans are considered a primary processor.

```{r}

secondary_processor <- margins %>%
  mutate(
    supply_chain_node = "secondary_processor", 
    margin_low = 0.08, 
    margin_high = 0.10)

```

## Wholesale/distributor

```{r}

# Dried beans
wholesale_dried <- margins %>% 
  mutate(
    supply_chain_node = "wholesale_distributor_dried", 
    margin_low = case_when(
     market_channel == "differentiated" ~ 0.20,
     market_channel != "differentiated" & 
       scale == "medium" ~ 0.08,
     market_channel != "differentiated" & 
       scale == "large" ~ 0.03),
    margin_high = case_when(
      market_channel == "differentiated" ~ 0.24, 
      market_channel != "differentiated" & 
       scale == "medium" ~ 0.10,
      market_channel != "differentiated" & 
       scale == "large" ~ 0.05)
    )

## Canned beans
wholesale_canned <- margins %>% 
  mutate(
    supply_chain_node = "wholesale_distributor_canned", 
    margin_low = case_when(
     market_channel == "differentiated" ~ 0.22,
     market_channel != "differentiated" & 
       scale == "medium" ~ 0.08,
     market_channel != "differentiated" & 
       scale == "large" ~ 0.03),
    margin_high = case_when(
      market_channel == "differentiated" ~ 0.26, 
      market_channel != "differentiated" & 
       scale == "medium" ~ 0.10,
      market_channel != "differentiated" & 
       scale == "large" ~ 0.05)
    )

```

## All margins and save

We combine all [margins and save the file](https://github.com/FoodSystemsModeling/CityFoodPolicy/tree/main/drybeans/data_final/margins.xlsx).

```{r}

# Combine
margins <- bind_rows(cleaner_agg, 
                  primary_processor_canning, 
                  primary_processor_bagging, 
                  secondary_processor, 
                  wholesale_canned, 
                  wholesale_dried)

# Add info
info <- tibble(
  sheet_name = "margins",
  description = "Margins along the dry bean supply chain, presented as a range from high to low. Data are separated by organic/conventional and by different types processes (e.g., canned/bagged, wholesale margin for dried/canned beans), and by scale. In many cases the margins are the across different categories.", 
  source = "Interviews with supply chain actors", 
  notes = "A margin is the percentage of the selling price that is profit. Margin = (selling price - cost)/selling price"
)

# Add worksheets and save
wb <- createWorkbook()
addWorksheet(wb, "info")
writeData(wb, "info", info)
addWorksheet(wb, "margins")
writeData(wb, "margins", margins)

saveWorkbook(wb, "data_final/margins.xlsx", 
             overwrite = TRUE)

```
